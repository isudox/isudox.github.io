<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Metaspace 堆积引起 Full GC 的排查</title>
  
  <meta name="description" content="摘要：线上系统频繁 Full GC，通过监控告警、GC 日志、Heap 分析，逐步定位根因，并确定修复思路。 问题现象 支付服务异地部署前，需要提前打开北京、">
  <meta name="author" content="isudox">
  
  <link href="https://isudox.com/an-old-hope.min.css" rel="stylesheet">
  <link href="https://isudox.com/style.css" rel="stylesheet">
  <link href="https://isudox.com/custom.css" rel="stylesheet">
  
  <link rel="apple-touch-icon" href="https://isudox.com/apple-touch-icon.png">
  <link rel="icon" href="https://isudox.com/favicon.ico">
  <meta name="generator" content="Hugo 0.82.0" />
  
  
</head>

<body class="single">
  <script>
    setTheme();
  </script>
  <header class="header">
    <nav class="nav">
      <p class="logo"><a href="https://isudox.com/">I sudo X</a></p>
      <ul class="menu">
        <li>
          <a class="menu-list-link" href="/posts/">文档</a>
          
        </li>
        <li>
          <a class="menu-list-link" href="/tags/">标签</a>
          
        </li>
        <li>
          <a class="menu-list-link" href="/about/">关于</a>
          
        </li>
      </ul>
    </nav>
  </header>
  <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Metaspace 堆积引起 Full GC 的排查</h1>
    <div class="post-meta">2021/03/10</div>
  </header>
  <div class="post-content"><blockquote>
<p>摘要：线上系统频繁 Full GC，通过监控告警、GC 日志、Heap 分析，逐步定位根因，并确定修复思路。</p>
</blockquote>
<!-- more -->
<h1 id="问题现象">问题现象</h1>
<p>支付服务异地部署前，需要提前打开北京、上海两地单元间数据副本的双向复制，以及存在互备关系的数据副本间的核对。当核对任务开启后，loader 模块却频繁发生 Full GC。</p>
<p><img src="/images/689195193.png" alt=""></p>
<p>公司的 CAT 监控：</p>
<p><img src="/images/689270418.png" alt=""></p>
<p>从上面 GC 监控图可以观察到，FGC 在各服务节点上都存在，且集中发生在当前小时的前十几分钟，而这也是核对任务开始调度执行的时间段。</p>
<h1 id="分析排查">分析排查</h1>
<h2 id="初步分析">初步分析</h2>
<p>发生 FGC 首先想到的是老年代使用空间超限，下图是 FGC 发生时，老年代的使用情况监控：</p>
<p><img src="/images/689270419.png" alt=""></p>
<p>可以看到，在 FGC 时老年代使用率并不高，处在正常水平，远远没有到达触发 FGC 的阈值。loader 模块的 jvm 主要参数有：</p>
<pre><code>-Xmx4g
-Xms4g
-XX:NewRatio=2
-XX:SurvivorRatio=8
-XX:PermSize=128m
-XX:MaxPermSize=256m
-XX:+PrintFlagsFinal
-XX:+PrintCommandLineFlags
-XX:+DisableExplicitGC
-XX:+UseConcMarkSweepGC
-XX:CMSFullGCsBeforeCompaction=0
-XX:+UseCMSCompactAtFullCollection
-XX:CMSInitiatingOccupancyFraction=70
-XX:+PrintGCDateStamps
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-XX:+PrintHeapAtGC
-XX:+PrintGCApplicationStoppedTime
-XX:+PrintTenuringDistribution
-XX:+HeapDumpOnOutOfMemoryError
-XX:+UseCMSInitiatingOccupancyOnly
-XX:MaxMetaspaceSize=256m
-XX:MetaspaceSize=128m
</code></pre><p>由此根因可以排除老年代增长过快导致 FGC。</p>
<h2 id="gc-日志分析">GC 日志分析</h2>
<p>选择一台主机，查看 GC 日志，直接定位 <code>Full GC</code> 关键字。</p>
<p><img src="/images/689197960.png" alt=""></p>
<p>从日志中明确了引起 FGC 的原因是触发了 Metadata GC Threshold，且 vim 中匹配了 12 次，即由于 metadata 堆积引起了 12 次 FGC。</p>
<p>回到 JVM 监控上查看 meta 区监控：</p>
<p><img src="/images/689197961.png" alt=""></p>
<p>FGC 和 metaspace 区使用上涨的时间点是重合的，从监控上也反映出了 gc 日志中的信息。</p>
<p>到这，问题的直接原因已经确认，就是由于 meta 区暴涨引起频繁 FGC。</p>
<h2 id="根因定位">根因定位</h2>
<p>接下来就需要分析是什么原因导致 meta 区被爆。</p>
<p>横向对比旧版的服务模块（engine + loader），老服务的 metaspace 区非常稳定（即使拉长时间区间，metaspace 区变化也非常小）。</p>
<p><img src="/images/689197962.png" alt=""></p>
<p>而 loader 模块逻辑非常简单，它只提供一个 RPC 接口，由 engine 模块传入数据查询的基本信息，通过 JDBC 执行 SQL。此外，loader 模块很长一段时间都没有变更（有流水线发布，但代码没有变更）。但可以确定的是：线上服务发生稳态的破坏，一定是引入了系统变量。联系最近一周的线上变更动作，有：</p>
<ul>
<li>engine 模块调整 SQL 生成方式；</li>
<li>新增北京、上海单元副本的核对任务，存量任务配置增加差集数据的过滤脚本；</li>
</ul>
<p>前者对 loader 的影响只是变更了实际执行的 SQL，因此初步推断相关性低；后者增加的过滤脚本，会在 loader 查询到结果集后，通过 Groovy 解析过滤掉差集数据，这个环节会创建清洗规则 <code>CleanRule</code> 的实例，但创建的临时变量会通过 YGC 回收掉，推断相关性也不大。</p>
<p>既然经验分析找不到根因，只能做 dump heap 分析。</p>
<h2 id="dump-heap">Dump Heap</h2>
<p>摘掉一个线上服务节点，dump 堆内存进行分析。考虑到 metaspace 区是用来存储 class 元信息，因此如果要爆掉 metaspace 区，必然是加载了大量 class。直接定位到类标签上，</p>
<p><img src="/images/689197963.png" alt=""></p>
<p>发现存在大量和 groovy 相关的类，而 loader 中使用到 groovy 的地方，只有上文提到的动态解析过滤规则。接着点开重复类标签，注意到有创建了大量 Script 对象，而且是通过不同的类加载器进行加载……</p>
<p><img src="/images/689197964.png" alt=""></p>
<p>从上面的 Heap 分析，基本可以得出下面的结论：</p>
<ol>
<li>
<p>metaspace 区存储了大量 groovy runtime 创建类的元信息，导致 metaspace 区使用短时间内暴涨；</p>
</li>
<li>
<p>loader 模块动态解析 groovy 脚本，是引起 metaspace 区被爆的诱因；</p>
</li>
</ol>
<h2 id="代码分析">代码分析</h2>
<p>下面是 loader 模块中，动态解析 groovy 脚本的代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotEmpty</span><span style="color:#f92672">(</span>cleanRule<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    dataCleanService<span style="color:#f92672">.</span><span style="color:#a6e22e">clean</span><span style="color:#f92672">(</span>rows<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> CleanRule<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Boolean <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> stringObjectMap<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            String field <span style="color:#f92672">=</span> GroovyParser<span style="color:#f92672">.</span><span style="color:#a6e22e">getField</span><span style="color:#f92672">(</span>cleanRule<span style="color:#f92672">);</span>
            String value <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> stringObjectMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>field<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotEmpty</span><span style="color:#f92672">(</span>field<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Binding binding <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Binding<span style="color:#f92672">();</span>
                binding<span style="color:#f92672">.</span><span style="color:#a6e22e">setVariable</span><span style="color:#f92672">(</span>field<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
                GroovyShell shell <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GroovyShell<span style="color:#f92672">(</span>binding<span style="color:#f92672">);</span>
                String command <span style="color:#f92672">=</span> GroovyParser<span style="color:#f92672">.</span><span style="color:#a6e22e">genCommand</span><span style="color:#f92672">(</span>cleanRule<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">)</span> shell<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>command<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里创建了 GroovyShell，并执行脚本。进入 <code>evaluate()</code> 方法看源码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">synchronized</span> String <span style="color:#a6e22e">generateScriptName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Script&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(++</span>counter<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.groovy&#34;</span><span style="color:#f92672">;</span> <span style="color:#75715e">// 此处就是 Script1 的由来
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String scriptText<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> CompilationFailedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> evaluate<span style="color:#f92672">(</span>scriptText<span style="color:#f92672">,</span> generateScriptName<span style="color:#f92672">(),</span> DEFAULT_CODE_BASE<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>GroovyCodeSource codeSource<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> CompilationFailedException <span style="color:#f92672">{</span>
    Script script <span style="color:#f92672">=</span> parse<span style="color:#f92672">(</span>codeSource<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> script<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> Script <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> GroovyCodeSource codeSource<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> CompilationFailedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> InvokerHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">createScript</span><span style="color:#f92672">(</span>parseClass<span style="color:#f92672">(</span>codeSource<span style="color:#f92672">),</span> context<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> Class <span style="color:#a6e22e">parseClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> GroovyCodeSource codeSource<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> CompilationFailedException <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Don&#39;t cache scripts
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> loader<span style="color:#f92672">.</span><span style="color:#a6e22e">parseClass</span><span style="color:#f92672">(</span>codeSource<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> Class <span style="color:#a6e22e">parseClass</span><span style="color:#f92672">(</span>GroovyCodeSource codeSource<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> shouldCacheSource<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> CompilationFailedException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>sourceCache<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Class answer <span style="color:#f92672">=</span> sourceCache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>answer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> answer<span style="color:#f92672">;</span>
        answer <span style="color:#f92672">=</span> doParseClass<span style="color:#f92672">(</span>codeSource<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldCacheSource<span style="color:#f92672">)</span> sourceCache<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> answer<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> answer<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> Class <span style="color:#a6e22e">doParseClass</span><span style="color:#f92672">(</span>GroovyCodeSource codeSource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    validate<span style="color:#f92672">(</span>codeSource<span style="color:#f92672">);</span>
    Class answer<span style="color:#f92672">;</span>  <span style="color:#75715e">// Was neither already loaded nor compiling, so compile and add to cache.
</span><span style="color:#75715e"></span>    CompilationUnit unit <span style="color:#f92672">=</span> createCompilationUnit<span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getCodeSource</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>recompile<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> recompile <span style="color:#f92672">||</span> recompile<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">getRecompileGroovySource</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        unit<span style="color:#f92672">.</span><span style="color:#a6e22e">addFirstPhaseOperation</span><span style="color:#f92672">(</span>TimestampAdder<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">,</span> CompilePhase<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASS_GENERATION</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPhaseNumber</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    SourceUnit su <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    File file <span style="color:#f92672">=</span> codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getFile</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        su <span style="color:#f92672">=</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">addSource</span><span style="color:#f92672">(</span>file<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        URL url <span style="color:#f92672">=</span> codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getURL</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>url <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            su <span style="color:#f92672">=</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">addSource</span><span style="color:#f92672">(</span>url<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            su <span style="color:#f92672">=</span> unit<span style="color:#f92672">.</span><span style="color:#a6e22e">addSource</span><span style="color:#f92672">(</span>codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> codeSource<span style="color:#f92672">.</span><span style="color:#a6e22e">getScriptText</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    ClassCollector collector <span style="color:#f92672">=</span> createCollector<span style="color:#f92672">(</span>unit<span style="color:#f92672">,</span> su<span style="color:#f92672">);</span>
    unit<span style="color:#f92672">.</span><span style="color:#a6e22e">setClassgenCallback</span><span style="color:#f92672">(</span>collector<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> goalPhase <span style="color:#f92672">=</span> Phases<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASS_GENERATION</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">getTargetDirectory</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> goalPhase <span style="color:#f92672">=</span> Phases<span style="color:#f92672">.</span><span style="color:#a6e22e">OUTPUT</span><span style="color:#f92672">;</span>
    unit<span style="color:#f92672">.</span><span style="color:#a6e22e">compile</span><span style="color:#f92672">(</span>goalPhase<span style="color:#f92672">);</span>

    answer <span style="color:#f92672">=</span> collector<span style="color:#f92672">.</span><span style="color:#a6e22e">generatedClass</span><span style="color:#f92672">;</span>
    String mainClass <span style="color:#f92672">=</span> su<span style="color:#f92672">.</span><span style="color:#a6e22e">getAST</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getMainClassName</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Object o <span style="color:#f92672">:</span> collector<span style="color:#f92672">.</span><span style="color:#a6e22e">getLoadedClasses</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        Class clazz <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">)</span> o<span style="color:#f92672">;</span>
        String clazzName <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
        definePackageInternal<span style="color:#f92672">(</span>clazzName<span style="color:#f92672">);</span>
        setClassCacheEntry<span style="color:#f92672">(</span>clazz<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazzName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mainClass<span style="color:#f92672">))</span> answer <span style="color:#f92672">=</span> clazz<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> answer<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">protected</span> ClassCollector <span style="color:#a6e22e">createCollector</span><span style="color:#f92672">(</span>CompilationUnit unit<span style="color:#f92672">,</span> SourceUnit su<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    InnerLoader loader <span style="color:#f92672">=</span> AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrivilegedAction<span style="color:#f92672">&lt;</span>InnerLoader<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> InnerLoader <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InnerLoader<span style="color:#f92672">(</span>GroovyClassLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ClassCollector<span style="color:#f92672">(</span>loader<span style="color:#f92672">,</span> unit<span style="color:#f92672">,</span> su<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的源码，我按调用栈依次粘贴，比较乱。可以直接看最后一个方法：</p>
<p><img src="/images/689461704.png" alt=""></p>
<p>注意到，每次执行 <code>evaluate</code> 方法时，都会创建一个新的 <code>ClassCollector</code> 实例来对脚本进行编译，这个过程中，在 <code>createCollector</code> 方法中，创建了 <code>InnerLoader</code> 类加载器。这也是为什么从上面的 heap 分析中，观察到大量通过 <code>GroovyClassLoader$InnerLoader</code> 加载的同名类 <code>Script1.class</code>。正是因为 <code>InnerLoader</code> 类加载器的存在，可以运行时创建 Groovy 脚本的多个类。</p>
<h1 id="场景复现和修复">场景复现和修复</h1>
<p>通过源码基本定位根因，实现一个 demo 简单复现下故障场景。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetaLeak</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        String rule <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[\&#34;hello\&#34;,\&#34;world\&#34;].contains(text)&#34;</span><span style="color:#f92672">;</span>
        Binding binding <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Binding<span style="color:#f92672">();</span>
        binding<span style="color:#f92672">.</span><span style="color:#a6e22e">setVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;hi&#34;</span><span style="color:#f92672">);</span>
        GroovyShell shell <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GroovyShell<span style="color:#f92672">(</span>binding<span style="color:#f92672">);</span>
        shell<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * -Xms128m
</span><span style="color:#75715e">     * -Xmx256m
</span><span style="color:#75715e">     * -XX:+HeapDumpOnOutOfMemoryError
</span><span style="color:#75715e">     * -XX:MetaspaceSize=10m
</span><span style="color:#75715e">     * -XX:MaxMetaspaceSize=20m
</span><span style="color:#75715e">     * -XX:+PrintGCDetails
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MetaLeak demo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetaLeak<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                demo<span style="color:#f92672">.</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>MetaLeak 类是存在 metaspace 区被爆隐患的，因为 for 循环执行时都在加载 <code>Script</code> 类。下面是运行过程中的部分 GC 日志：</p>
<p><img src="/images/689463877.png" alt=""></p>
<p>高频出现 Metadata 被爆导致的 FGC，另外 Last ditch collection 是由于上一次 FGC 没有将 metaspace 区清理出足够空间。</p>
<p>因此，修复思路是规避掉频繁解析规则，即已经解析过的规则，直接复用 Script 实例，不再动态编译加载。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetaSafe</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Script<span style="color:#f92672">&gt;</span> store <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> GroovyShell SHELL <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GroovyShell<span style="color:#f92672">();</span>

    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
        SHELL<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;123456&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        String rule <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[\&#34;hello\&#34;,\&#34;world\&#34;].contains(text)&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>store<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            store<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> SHELL<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
        store<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">).</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * -Xms128m
</span><span style="color:#75715e">     * -Xmx256m
</span><span style="color:#75715e">     * -XX:+HeapDumpOnOutOfMemoryError
</span><span style="color:#75715e">     * -XX:MetaspaceSize=10m
</span><span style="color:#75715e">     * -XX:MaxMetaspaceSize=20m
</span><span style="color:#75715e">     * -XX:+PrintGCDetails
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MetaSafe demo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetaSafe<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                demo<span style="color:#f92672">.</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>运行后，Metaspace 区使用率正常。</p>
</div>

  

<div id="disqus_thread"></div>
<script>
    

    

    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;
        var d = document, s = d.createElement('script');
        
        var disqus_shortname = 'isudox';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article></main>
<footer class="footer">
  <span>&copy; 2015 - 2021</span>
  <span>&middot;</span>
  <span><a href="https://isudox.com/">I sudo X</a></span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Theme️ <a href="https://github.com/isudox/hugo-theme-nova/" rel="noopener" target="_blank">Nova</a></span>
</footer>
<script src="https://isudox.com/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>

</html>

