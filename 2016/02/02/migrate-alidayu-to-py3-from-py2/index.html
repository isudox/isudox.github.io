<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>阿里大鱼短信 SDK 迁移到 Python 3.x</title>
  
  <meta name="description" content="近期课余时间开发一个基于 Django 的 RESTful Web Service，需要接入短信验证发送功能，比较之后选定阿里大鱼的解决方案。 然而，选 Python 作为技术栈的悲催之处在于">
  <meta name="author" content="isudox">
  
  <link href="https://isudox.com/style.css" rel="stylesheet">
  <link href="https://isudox.com/custom.css" rel="stylesheet">
  
  <link rel="apple-touch-icon" href="https://isudox.com/apple-touch-icon.png">
  <link rel="icon" href="https://isudox.com/favicon.ico">
  <meta name="generator" content="Hugo 0.83.1" />
  
  
</head>

<body class="single">
  <script>
    setTheme();
  </script>
  <header class="header">
    <nav class="nav">
      <p class="logo"><a href="https://isudox.com/">I sudo X</a></p>
      <ul class="menu">
        <li>
          <a class="menu-list-link" href="/posts/">文档</a>
          
        </li>
        <li>
          <a class="menu-list-link" href="/tags/">标签</a>
          
        </li>
        <li>
          <a class="menu-list-link" href="/about/">关于</a>
          
        </li>
      </ul>
    </nav>
  </header>
  <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">阿里大鱼短信 SDK 迁移到 Python 3.x</h1>
    <div class="post-meta">2016/02/02</div>
  </header>
  <div class="post-content"><p>近期课余时间开发一个基于 Django 的 RESTful Web Service，需要接入短信验证发送功能，比较之后选定<a href="http://www.alidayu.com/">阿里大鱼</a>的解决方案。</p>
<p>然而，选 Python 作为技术栈的悲催之处在于，虽然 Python 的第三方库和生态很强大，但是就国内的开发圈而言，Python 是一个相对小众的流派，又由于 Python 2.x 和 Python 3.x 的分化，许多第三方库并没有跟进 Python 3，导致很多时候用 Python 会有些捉襟见肘，尤其是像我这种野路子的 Python 开发。</p>
<!-- more -->
<p>比如阿里大鱼的短信方案，虽然相比其他厂商很良心的在 PHP 、 Java 版 SDK 之外，友情附赠了 Python 版，但集成进 Django 工程并 debug 后，真是握了棵草，它是基于 Python 2.x 开发的，翻了下开发包源码文件，署名为 “lihao” 的这位阿里同学是在 2012 年更新的源码，这竟是一份蒙尘多年的代码啊，当时我的内心是奔溃的……</p>
<blockquote>
<p>自己动手，丰衣足食。——《毛选》</p>
</blockquote>
<p>阿里大鱼短信开发包的源码并不复杂，来来去去无非一些 request，response 和 string 的处理，底层都是在阿里服务端 api 里实现的，短信包只是提供 api 调用、处理功能，因此迁移工作倒也不是很令人拙计。下面就把我填的坑一一道来（难免有遗忘和疏漏，见谅）——</p>
<h4 id="一号坑">一号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#93a1a1;font-style:italic"># 如果parameters是字典类</span>
<span style="color:#268bd2">keys</span> = <span style="color:#268bd2">parameters</span>.<span style="color:#268bd2">keys</span>()
</code></pre></div><p>不出所料的话，控制台会输出
<code>&gt;&gt;&gt;TypeError: 'dict_keys' object does not support indexing</code>
这是一大坑，在 Python 3.x 里，<code>dict.keys()</code>, <code>dict.values()</code> 和 <code>dict.items()</code> 是返回一个 <code>dict_keys</code> 对象（dict_keys 不支持 indexing），而不是 Python 2.x 那样返回一个 <code>list</code>。因此最简单的迁移方法就是显式调用 <code>list()</code> 处理，</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#93a1a1;font-style:italic"># 如果parameters是字典类</span>
<span style="color:#268bd2">keys</span> = <span style="color:#cb4b16">list</span>(<span style="color:#268bd2">parameters</span>.<span style="color:#268bd2">keys</span>())
</code></pre></div><p>但实际上，这种处理办法并不是最优解，可参考 <a href="http://blog.labix.org/2008/06/27/watch-out-for-listdictkeys-in-python-3">Watch out for list(dict.keys()) in Python 3</a></p>
<h4 id="二号坑">二号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">sign</span> = <span style="color:#268bd2">hashlib</span>.<span style="color:#268bd2">md5</span>(<span style="color:#268bd2">parameters</span>).<span style="color:#268bd2">hexdigest</span>().<span style="color:#268bd2">upper</span>()
</code></pre></div><p>哈哈，控制台会报如下错
<code>&gt;&gt;&gt;Python hashlib problem “TypeError: Unicode-objects must be encoded before hashing”</code>
言简意赅，debug 信息已经给出了解决方案，上述代码中的 parameters 参数必须先 encoded 后才能 hash。So easy!</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">sign</span> = <span style="color:#268bd2">hashlib</span>.<span style="color:#268bd2">md5</span>(<span style="color:#268bd2">parameters</span>.<span style="color:#268bd2">encode</span>(<span style="color:#2aa198">&#39;utf8&#39;</span>)).<span style="color:#268bd2">hexdigest</span>().<span style="color:#268bd2">upper</span>()
</code></pre></div><p>utf-8 转码后就没问题了，一个赛艇！</p>
<h4 id="三号坑">三号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#859900">if</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">str</span>)):
    <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>
<span style="color:#859900">elif</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">unicode</span>)):
    <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>.<span style="color:#268bd2">encode</span>(<span style="color:#2aa198">&#39;utf-8&#39;</span>)
</code></pre></div><p>运行后的错误信息：
<code>&gt;&gt;&gt;NameError: global name 'unicode' is not defined</code>
Python 3.x 把 <code>unicode</code> 类型改名为 <code>str</code>，而原来 Python 2.x 下的 <code>str</code> 类型被 <code>bytes</code> 替代。所以解决办法就是按 Python 3.x 的定义来</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#859900">if</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">bytes</span>)):
    <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>
<span style="color:#859900">elif</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">str</span>)):
    <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>.<span style="color:#268bd2">encode</span>(<span style="color:#2aa198">&#39;utf-8&#39;</span>)
</code></pre></div><h4 id="四号坑">四号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">connection</span> = <span style="color:#268bd2">httplib</span>.<span style="color:#268bd2">HTTPConnection</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">__domain</span>, <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__port</span>, <span style="color:#268bd2">False</span>, <span style="color:#268bd2">timeout</span>)
</code></pre></div><p>这里需要注意的地方有两处，Python 2.x 的 httplib 包的 import 路径为
<code>import httplib</code>
在 Python 3.x 里的 import 路径则是：
<code>import http.client as httplib</code>
还有一处注意点是，在更改了包路径后，httplib.HTTPConnection(httplib.HTTPConnection() 的参数也发生了变化，
Python 2.x 中该接口为
<code>httplib.HTTPConnection(host[, port[, strict[, timeout[, source_address]]]])</code>
其中，strict 默认为 False，而 Python 3.x 里该接口则修改成
<code>httplib.HTTPConnection(self, host, port=None, timeout=socket._GLOBAL_DEFAULT_TIMEOUT, source_address=None）</code>
很显然，阿里源码里的传参是按照 Python 2.x 的写法，对照 Python 3.x 接口改过来便是</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">connection</span> = <span style="color:#268bd2">httplib</span>.<span style="color:#268bd2">HTTPConnection</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">__domain</span>, <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__port</span>, <span style="color:#268bd2">timeout</span>)
</code></pre></div><h4 id="五号坑">五号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">P_TIMESTAMP</span>: <span style="color:#cb4b16">str</span>(<span style="color:#cb4b16">long</span>(<span style="color:#268bd2">time</span>.<span style="color:#268bd2">time</span>() * <span style="color:#2aa198;font-weight:bold">1000</span>))
</code></pre></div><p><code>&gt;&gt;&gt;NameError: name 'long' is not defined</code>
Python 3.x 已经将 Python 2.x 中的 <code>int</code> 和 <code>long</code> 型合并为 <code>int</code>，因此在 Python 3.x 下，已经不存在 <code>long</code> 类型了。修改成<code>int()</code>即可</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">P_TIMESTAMP</span>: <span style="color:#cb4b16">str</span>(<span style="color:#cb4b16">int</span>(<span style="color:#268bd2">time</span>.<span style="color:#268bd2">time</span>() * <span style="color:#2aa198;font-weight:bold">1000</span>))
</code></pre></div><h4 id="六号坑">六号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#dc322f;font-weight:bold">from</span> <span style="color:#268bd2">urllib</span> <span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">urlencode</span>
<span style="color:#268bd2">body</span> = <span style="color:#268bd2">urllib</span>.<span style="color:#268bd2">urlencode</span>(<span style="color:#268bd2">application_parameter</span>)
</code></pre></div><p>Python 3.x 把 Python 2.x 下 <code>urlencode()</code> 函数转移到了 <code>urllib.parse</code> 里。修改为</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#dc322f;font-weight:bold">from</span> <span style="color:#268bd2">urllib.parse</span> <span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">urlencode</span>
<span style="color:#268bd2">body</span> = <span style="color:#268bd2">urllib</span>.<span style="color:#268bd2">parse</span>.<span style="color:#268bd2">urlencode</span>(<span style="color:#268bd2">application_parameter</span>)
</code></pre></div><h4 id="七号坑">七号坑</h4>
<pre><code>result = response.read()
jsonobj = json.loads(result)
</code></pre><p>Python 3.x 里 JSON 只接收 unicode，因此 result 需要转码为 unicode</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#268bd2">result</span> = <span style="color:#268bd2">response</span>.<span style="color:#268bd2">read</span>().<span style="color:#268bd2">decode</span>(<span style="color:#2aa198">&#39;utf-8&#39;</span>)
<span style="color:#268bd2">jsonobj</span> = <span style="color:#268bd2">json</span>.<span style="color:#268bd2">loads</span>(<span style="color:#268bd2">result</span>)
</code></pre></div><h4 id="八号坑">八号坑</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#859900">for</span> <span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">application_parameter</span>.<span style="color:#268bd2">iteritems</span>():
    <span style="color:#859900">pass</span>
</code></pre></div><p>控制台报错：
<code>&gt;&gt;&gt;AttributeError: 'dict' object has no attribute 'iteritems'</code>
字典没有 iteritems 属性？原来是 Python 3.x 已经把 <code>iteritems()</code> 给移除掉了，因此不能再调用该方法。
参考 <a href="https://wiki.python.org/moin/Python3.0">Python Wiki</a>:</p>
<blockquote>
<p>Remove dict.iteritems(), dict.iterkeys(), and dict.itervalues().
Instead: use dict.items(), dict.keys(), and dict.values() respectively.</p>
</blockquote>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#859900">for</span> <span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">application_parameter</span>.<span style="color:#268bd2">items</span>():
    <span style="color:#859900">pass</span>
</code></pre></div><p>Done!</p>
<h4 id="python-3x-版本的-basepy">Python 3.x 版本的 base.py</h4>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#93a1a1;font-style:italic"># base.py</span>
<span style="color:#93a1a1;font-style:italic"># -*- coding: utf-8 -*-</span>
<span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">Created on 2012-7-3
</span><span style="color:#2aa198">
</span><span style="color:#2aa198">@author: lihao
</span><span style="color:#2aa198">&#34;&#34;&#34;</span>

<span style="color:#859900">try</span>:
    <span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">httplib</span>
<span style="color:#859900">except</span> <span style="color:#268bd2">ImportError</span>:
    <span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">http.client</span> <span style="color:#dc322f;font-weight:bold">as</span> <span style="color:#268bd2">httplib</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">urllib</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">time</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">hashlib</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">json</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">top</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">itertools</span>
<span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">mimetypes</span>
<span style="color:#dc322f;font-weight:bold">from</span> <span style="color:#268bd2">urllib.parse</span> <span style="color:#dc322f;font-weight:bold">import</span> <span style="color:#268bd2">urlencode</span>

<span style="color:#2aa198">&#39;&#39;&#39;
</span><span style="color:#2aa198">定义一些系统变量
</span><span style="color:#2aa198">&#39;&#39;&#39;</span>

<span style="color:#268bd2">SYSTEM_GENERATE_VERSION</span> = <span style="color:#2aa198">&#34;taobao-sdk-python-20151217&#34;</span>

<span style="color:#268bd2">P_APPKEY</span> = <span style="color:#2aa198">&#34;app_key&#34;</span>
<span style="color:#268bd2">P_API</span> = <span style="color:#2aa198">&#34;method&#34;</span>
<span style="color:#268bd2">P_SESSION</span> = <span style="color:#2aa198">&#34;session&#34;</span>
<span style="color:#268bd2">P_ACCESS_TOKEN</span> = <span style="color:#2aa198">&#34;access_token&#34;</span>
<span style="color:#268bd2">P_VERSION</span> = <span style="color:#2aa198">&#34;v&#34;</span>
<span style="color:#268bd2">P_FORMAT</span> = <span style="color:#2aa198">&#34;format&#34;</span>
<span style="color:#268bd2">P_TIMESTAMP</span> = <span style="color:#2aa198">&#34;timestamp&#34;</span>
<span style="color:#268bd2">P_SIGN</span> = <span style="color:#2aa198">&#34;sign&#34;</span>
<span style="color:#268bd2">P_SIGN_METHOD</span> = <span style="color:#2aa198">&#34;sign_method&#34;</span>
<span style="color:#268bd2">P_PARTNER_ID</span> = <span style="color:#2aa198">&#34;partner_id&#34;</span>

<span style="color:#268bd2">P_CODE</span> = <span style="color:#2aa198">&#39;code&#39;</span>
<span style="color:#268bd2">P_SUB_CODE</span> = <span style="color:#2aa198">&#39;sub_code&#39;</span>
<span style="color:#268bd2">P_MSG</span> = <span style="color:#2aa198">&#39;msg&#39;</span>
<span style="color:#268bd2">P_SUB_MSG</span> = <span style="color:#2aa198">&#39;sub_msg&#39;</span>

<span style="color:#268bd2">N_REST</span> = <span style="color:#2aa198">&#39;/router/rest&#39;</span>


<span style="color:#859900">def</span> <span style="color:#268bd2">sign</span>(<span style="color:#268bd2">secret</span>, <span style="color:#268bd2">parameters</span>):
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#93a1a1;font-style:italic"># &#39;&#39;&#39;签名方法</span>
    <span style="color:#93a1a1;font-style:italic"># @param secret: 签名需要的密钥</span>
    <span style="color:#93a1a1;font-style:italic"># @param parameters: 支持字典和string两种</span>
    <span style="color:#93a1a1;font-style:italic"># &#39;&#39;&#39;</span>
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#93a1a1;font-style:italic"># 如果parameters 是字典类的话</span>
    <span style="color:#859900">if</span> <span style="color:#cb4b16">hasattr</span>(<span style="color:#268bd2">parameters</span>, <span style="color:#2aa198">&#34;items&#34;</span>):
        <span style="color:#93a1a1;font-style:italic"># keys = parameters.keys()</span>
        <span style="color:#268bd2">keys</span> = <span style="color:#cb4b16">list</span>(<span style="color:#268bd2">parameters</span>.<span style="color:#268bd2">keys</span>())  <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
        <span style="color:#268bd2">keys</span>.<span style="color:#268bd2">sort</span>()

        <span style="color:#268bd2">parameters</span> = <span style="color:#2aa198">&#34;</span><span style="color:#2aa198">%s%s%s</span><span style="color:#2aa198">&#34;</span> % (<span style="color:#268bd2">secret</span>,
                                 <span style="color:#cb4b16">str</span>().<span style="color:#268bd2">join</span>(
                                         <span style="color:#2aa198">&#39;</span><span style="color:#2aa198">%s%s</span><span style="color:#2aa198">&#39;</span> % (<span style="color:#268bd2">key</span>, <span style="color:#268bd2">parameters</span>[<span style="color:#268bd2">key</span>]) <span style="color:#859900">for</span> <span style="color:#268bd2">key</span>
                                         <span style="color:#859900">in</span> <span style="color:#268bd2">keys</span>),
                                 <span style="color:#268bd2">secret</span>)
    <span style="color:#93a1a1;font-style:italic"># sign = hashlib.md5(parameters).hexdigest().upper()</span>
    <span style="color:#268bd2">sign</span> = <span style="color:#268bd2">hashlib</span>.<span style="color:#268bd2">md5</span>(<span style="color:#268bd2">parameters</span>.<span style="color:#268bd2">encode</span>(<span style="color:#2aa198">&#39;utf8&#39;</span>)).<span style="color:#268bd2">hexdigest</span>().<span style="color:#268bd2">upper</span>()   <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
    <span style="color:#859900">return</span> <span style="color:#268bd2">sign</span>


<span style="color:#859900">def</span> <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">pstr</span>):
    <span style="color:#859900">if</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">str</span>)):
        <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>
    <span style="color:#93a1a1;font-style:italic"># elif(isinstance(pstr, unicode)):</span>
    <span style="color:#859900">elif</span> (<span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">pstr</span>, <span style="color:#cb4b16">str</span>)):  <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
        <span style="color:#859900">return</span> <span style="color:#268bd2">pstr</span>.<span style="color:#268bd2">encode</span>(<span style="color:#2aa198">&#39;utf-8&#39;</span>)
    <span style="color:#859900">else</span>:
        <span style="color:#859900">return</span> <span style="color:#cb4b16">str</span>(<span style="color:#268bd2">pstr</span>)


<span style="color:#859900">class</span> <span style="color:#cb4b16">FileItem</span>(<span style="color:#cb4b16">object</span>):
    <span style="color:#859900">def</span> <span style="color:#268bd2">__init__</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">filename</span>=<span style="color:#268bd2">None</span>, <span style="color:#268bd2">content</span>=<span style="color:#268bd2">None</span>):
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">filename</span> = <span style="color:#268bd2">filename</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">content</span> = <span style="color:#268bd2">content</span>


<span style="color:#859900">class</span> <span style="color:#cb4b16">MultiPartForm</span>(<span style="color:#cb4b16">object</span>):
    <span style="color:#2aa198">&#34;&#34;&#34;Accumulate the data to be used when posting a form.&#34;&#34;&#34;</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">__init__</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">form_fields</span> = []
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">files</span> = []
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">boundary</span> = <span style="color:#2aa198">&#34;PYTHON_SDK_BOUNDARY&#34;</span>
        <span style="color:#859900">return</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">get_content_type</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">return</span> <span style="color:#2aa198">&#39;multipart/form-data; boundary=</span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#39;</span> % <span style="color:#268bd2">self</span>.<span style="color:#268bd2">boundary</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">add_field</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">name</span>, <span style="color:#268bd2">value</span>):
        <span style="color:#2aa198">&#34;&#34;&#34;Add a simple field to the form data.&#34;&#34;&#34;</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">form_fields</span>.<span style="color:#268bd2">append</span>((<span style="color:#268bd2">name</span>, <span style="color:#cb4b16">str</span>(<span style="color:#268bd2">value</span>)))
        <span style="color:#859900">return</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">add_file</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">fieldname</span>, <span style="color:#268bd2">filename</span>, <span style="color:#268bd2">fileHandle</span>, <span style="color:#268bd2">mimetype</span>=<span style="color:#268bd2">None</span>):
        <span style="color:#2aa198">&#34;&#34;&#34;Add a file to be uploaded.&#34;&#34;&#34;</span>
        <span style="color:#268bd2">body</span> = <span style="color:#268bd2">fileHandle</span>.<span style="color:#268bd2">read</span>()
        <span style="color:#859900">if</span> <span style="color:#268bd2">mimetype</span> <span style="color:#859900">is</span> <span style="color:#268bd2">None</span>:
            <span style="color:#268bd2">mimetype</span> = <span style="color:#268bd2">mimetypes</span>.<span style="color:#268bd2">guess_type</span>(<span style="color:#268bd2">filename</span>)[
                           <span style="color:#2aa198;font-weight:bold">0</span>] <span style="color:#859900">or</span> <span style="color:#2aa198">&#39;application/octet-stream&#39;</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">files</span>.<span style="color:#268bd2">append</span>((
                          <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">fieldname</span>), <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">filename</span>), <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">mimetype</span>),
                          <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">body</span>)))
        <span style="color:#859900">return</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">__str__</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#2aa198">&#34;&#34;&#34;Return a string representing the form data, including attached files.&#34;&#34;&#34;</span>
        <span style="color:#93a1a1;font-style:italic"># Build a list of lists, each containing &#34;lines&#34; of the</span>
        <span style="color:#93a1a1;font-style:italic"># request.  Each part is separated by a boundary string.</span>
        <span style="color:#93a1a1;font-style:italic"># Once the list is built, return a string where each</span>
        <span style="color:#93a1a1;font-style:italic"># line is separated by &#39;\r\n&#39;.  </span>
        <span style="color:#268bd2">parts</span> = []
        <span style="color:#268bd2">part_boundary</span> = <span style="color:#2aa198">&#39;--&#39;</span> + <span style="color:#268bd2">self</span>.<span style="color:#268bd2">boundary</span>

        <span style="color:#93a1a1;font-style:italic"># Add the form fields</span>
        <span style="color:#268bd2">parts</span>.<span style="color:#268bd2">extend</span>(
                [<span style="color:#268bd2">part_boundary</span>,
                 <span style="color:#2aa198">&#39;Content-Disposition: form-data; name=&#34;</span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;&#39;</span> % <span style="color:#268bd2">name</span>,
                 <span style="color:#2aa198">&#39;Content-Type: text/plain; charset=UTF-8&#39;</span>,
                 <span style="color:#2aa198">&#39;&#39;</span>,
                 <span style="color:#268bd2">value</span>,
                 ]
                <span style="color:#859900">for</span> <span style="color:#268bd2">name</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">form_fields</span>
        )

        <span style="color:#93a1a1;font-style:italic"># Add the files to upload</span>
        <span style="color:#268bd2">parts</span>.<span style="color:#268bd2">extend</span>(
                [<span style="color:#268bd2">part_boundary</span>,
                 <span style="color:#2aa198">&#39;Content-Disposition: file; name=&#34;</span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;; filename=&#34;</span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;&#39;</span> % \
                 (<span style="color:#268bd2">field_name</span>, <span style="color:#268bd2">filename</span>),
                 <span style="color:#2aa198">&#39;Content-Type: </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#39;</span> % <span style="color:#268bd2">content_type</span>,
                 <span style="color:#2aa198">&#39;Content-Transfer-Encoding: binary&#39;</span>,
                 <span style="color:#2aa198">&#39;&#39;</span>,
                 <span style="color:#268bd2">body</span>,
                 ]
                <span style="color:#859900">for</span> <span style="color:#268bd2">field_name</span>, <span style="color:#268bd2">filename</span>, <span style="color:#268bd2">content_type</span>, <span style="color:#268bd2">body</span> <span style="color:#859900">in</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">files</span>
        )

        <span style="color:#93a1a1;font-style:italic"># Flatten the list and add closing boundary marker,</span>
        <span style="color:#93a1a1;font-style:italic"># then return CR+LF separated data</span>
        <span style="color:#268bd2">flattened</span> = <span style="color:#cb4b16">list</span>(<span style="color:#268bd2">itertools</span>.<span style="color:#268bd2">chain</span>(*<span style="color:#268bd2">parts</span>))
        <span style="color:#268bd2">flattened</span>.<span style="color:#268bd2">append</span>(<span style="color:#2aa198">&#39;--&#39;</span> + <span style="color:#268bd2">self</span>.<span style="color:#268bd2">boundary</span> + <span style="color:#2aa198">&#39;--&#39;</span>)
        <span style="color:#268bd2">flattened</span>.<span style="color:#268bd2">append</span>(<span style="color:#2aa198">&#39;&#39;</span>)
        <span style="color:#859900">return</span> <span style="color:#2aa198">&#39;</span><span style="color:#2aa198">\r\n</span><span style="color:#2aa198">&#39;</span>.<span style="color:#268bd2">join</span>(<span style="color:#268bd2">flattened</span>)


<span style="color:#859900">class</span> <span style="color:#cb4b16">TopException</span>(<span style="color:#268bd2">Exception</span>):
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#93a1a1;font-style:italic"># 业务异常类</span>
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#859900">def</span> <span style="color:#268bd2">__init__</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">errorcode</span> = <span style="color:#268bd2">None</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">message</span> = <span style="color:#268bd2">None</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">subcode</span> = <span style="color:#268bd2">None</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">submsg</span> = <span style="color:#268bd2">None</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">application_host</span> = <span style="color:#268bd2">None</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">service_host</span> = <span style="color:#268bd2">None</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">__str__</span>(<span style="color:#268bd2">self</span>, *<span style="color:#268bd2">args</span>, **<span style="color:#268bd2">kwargs</span>):
        <span style="color:#268bd2">sb</span> = <span style="color:#2aa198">&#34;errorcode=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">errorcode</span>) + \
             <span style="color:#2aa198">&#34; message=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">message</span>) + \
             <span style="color:#2aa198">&#34; subcode=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">subcode</span>) + \
             <span style="color:#2aa198">&#34; submsg=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">submsg</span>) + \
             <span style="color:#2aa198">&#34; application_host=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">application_host</span>) + \
             <span style="color:#2aa198">&#34; service_host=&#34;</span> + <span style="color:#268bd2">mixStr</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">service_host</span>)
        <span style="color:#859900">return</span> <span style="color:#268bd2">sb</span>


<span style="color:#859900">class</span> <span style="color:#cb4b16">RequestException</span>(<span style="color:#268bd2">Exception</span>):
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#93a1a1;font-style:italic"># 请求连接异常类</span>
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#859900">pass</span>


<span style="color:#859900">class</span> <span style="color:#cb4b16">RestApi</span>(<span style="color:#cb4b16">object</span>):
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>
    <span style="color:#93a1a1;font-style:italic"># Rest api的基类</span>
    <span style="color:#93a1a1;font-style:italic"># ===========================================================================</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">__init__</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">domain</span>=<span style="color:#2aa198">&#39;gw.api.taobao.com&#39;</span>, <span style="color:#268bd2">port</span>=<span style="color:#2aa198;font-weight:bold">80</span>):
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#93a1a1;font-style:italic"># 初始化基类</span>
        <span style="color:#93a1a1;font-style:italic"># Args @param domain: 请求的域名或者ip</span>
        <span style="color:#93a1a1;font-style:italic">#      @param port: 请求的端口</span>
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__domain</span> = <span style="color:#268bd2">domain</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__port</span> = <span style="color:#268bd2">port</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__httpmethod</span> = <span style="color:#2aa198">&#34;POST&#34;</span>
        <span style="color:#859900">if</span> (<span style="color:#268bd2">top</span>.<span style="color:#268bd2">getDefaultAppInfo</span>()):
            <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__app_key</span> = <span style="color:#268bd2">top</span>.<span style="color:#268bd2">getDefaultAppInfo</span>().<span style="color:#268bd2">appkey</span>
            <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__secret</span> = <span style="color:#268bd2">top</span>.<span style="color:#268bd2">getDefaultAppInfo</span>().<span style="color:#268bd2">secret</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">get_request_header</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">return</span> {
            <span style="color:#2aa198">&#39;Content-type&#39;</span>: <span style="color:#2aa198">&#39;application/x-www-form-urlencoded;charset=UTF-8&#39;</span>,
            <span style="color:#2aa198">&#34;Cache-Control&#34;</span>: <span style="color:#2aa198">&#34;no-cache&#34;</span>,
            <span style="color:#2aa198">&#34;Connection&#34;</span>: <span style="color:#2aa198">&#34;Keep-Alive&#34;</span>,
        }

    <span style="color:#859900">def</span> <span style="color:#268bd2">set_app_info</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">appinfo</span>):
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#93a1a1;font-style:italic"># 设置请求的app信息</span>
        <span style="color:#93a1a1;font-style:italic"># @param appinfo: import top</span>
        <span style="color:#93a1a1;font-style:italic">#                 appinfo top.appinfo(appkey,secret)</span>
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__app_key</span> = <span style="color:#268bd2">appinfo</span>.<span style="color:#268bd2">appkey</span>
        <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__secret</span> = <span style="color:#268bd2">appinfo</span>.<span style="color:#268bd2">secret</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">getapiname</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">return</span> <span style="color:#2aa198">&#34;&#34;</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">getMultipartParas</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">return</span> []

    <span style="color:#859900">def</span> <span style="color:#268bd2">getTranslateParas</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">return</span> {}

    <span style="color:#859900">def</span> <span style="color:#268bd2">_check_requst</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#859900">pass</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">getResponse</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">authrize</span>=<span style="color:#268bd2">None</span>, <span style="color:#268bd2">timeout</span>=<span style="color:#2aa198;font-weight:bold">30</span>):
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#93a1a1;font-style:italic"># 获取response结果</span>
        <span style="color:#93a1a1;font-style:italic"># =======================================================================</span>
        <span style="color:#93a1a1;font-style:italic"># connection = httplib.HTTPConnection(self.__domain, self.__port, False,</span>
        <span style="color:#93a1a1;font-style:italic">#                                     timeout)</span>
        <span style="color:#268bd2">connection</span> = <span style="color:#268bd2">httplib</span>.<span style="color:#268bd2">HTTPConnection</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">__domain</span>, <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__port</span>, <span style="color:#268bd2">timeout</span>)    <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
        <span style="color:#268bd2">sys_parameters</span> = {
            <span style="color:#268bd2">P_FORMAT</span>: <span style="color:#2aa198">&#39;json&#39;</span>,
            <span style="color:#268bd2">P_APPKEY</span>: <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__app_key</span>,
            <span style="color:#268bd2">P_SIGN_METHOD</span>: <span style="color:#2aa198">&#34;md5&#34;</span>,
            <span style="color:#268bd2">P_VERSION</span>: <span style="color:#2aa198">&#39;2.0&#39;</span>,
            <span style="color:#93a1a1;font-style:italic"># P_TIMESTAMP: str(long(time.time() * 1000)),</span>
            <span style="color:#268bd2">P_TIMESTAMP</span>: <span style="color:#cb4b16">str</span>(<span style="color:#cb4b16">int</span>(<span style="color:#268bd2">time</span>.<span style="color:#268bd2">time</span>() * <span style="color:#2aa198;font-weight:bold">1000</span>)),  <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
            <span style="color:#268bd2">P_PARTNER_ID</span>: <span style="color:#268bd2">SYSTEM_GENERATE_VERSION</span>,
            <span style="color:#268bd2">P_API</span>: <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getapiname</span>(),
        }
        <span style="color:#859900">if</span> <span style="color:#268bd2">authrize</span> <span style="color:#859900">is</span> <span style="color:#859900">not</span> <span style="color:#268bd2">None</span>:
            <span style="color:#268bd2">sys_parameters</span>[<span style="color:#268bd2">P_SESSION</span>] = <span style="color:#268bd2">authrize</span>
        <span style="color:#268bd2">application_parameter</span> = <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getApplicationParameters</span>()
        <span style="color:#268bd2">sign_parameter</span> = <span style="color:#268bd2">sys_parameters</span>.<span style="color:#268bd2">copy</span>()
        <span style="color:#268bd2">sign_parameter</span>.<span style="color:#268bd2">update</span>(<span style="color:#268bd2">application_parameter</span>)
        <span style="color:#268bd2">sys_parameters</span>[<span style="color:#268bd2">P_SIGN</span>] = <span style="color:#268bd2">sign</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">__secret</span>, <span style="color:#268bd2">sign_parameter</span>)
        <span style="color:#268bd2">connection</span>.<span style="color:#268bd2">connect</span>()

        <span style="color:#268bd2">header</span> = <span style="color:#268bd2">self</span>.<span style="color:#268bd2">get_request_header</span>()
        <span style="color:#859900">if</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getMultipartParas</span>():
            <span style="color:#268bd2">form</span> = <span style="color:#268bd2">MultiPartForm</span>()
            <span style="color:#859900">for</span> <span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">application_parameter</span>.<span style="color:#268bd2">items</span>():
                <span style="color:#268bd2">form</span>.<span style="color:#268bd2">add_field</span>(<span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span>)
            <span style="color:#859900">for</span> <span style="color:#268bd2">key</span> <span style="color:#859900">in</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getMultipartParas</span>():
                <span style="color:#268bd2">fileitem</span> = <span style="color:#cb4b16">getattr</span>(<span style="color:#268bd2">self</span>, <span style="color:#268bd2">key</span>)
                <span style="color:#859900">if</span> <span style="color:#268bd2">fileitem</span> <span style="color:#859900">and</span> <span style="color:#cb4b16">isinstance</span>(<span style="color:#268bd2">fileitem</span>, <span style="color:#268bd2">FileItem</span>):
                    <span style="color:#268bd2">form</span>.<span style="color:#268bd2">add_file</span>(<span style="color:#268bd2">key</span>, <span style="color:#268bd2">fileitem</span>.<span style="color:#268bd2">filename</span>, <span style="color:#268bd2">fileitem</span>.<span style="color:#268bd2">content</span>)
            <span style="color:#268bd2">body</span> = <span style="color:#cb4b16">str</span>(<span style="color:#268bd2">form</span>)
            <span style="color:#268bd2">header</span>[<span style="color:#2aa198">&#39;Content-type&#39;</span>] = <span style="color:#268bd2">form</span>.<span style="color:#268bd2">get_content_type</span>()
        <span style="color:#859900">else</span>:
            <span style="color:#93a1a1;font-style:italic"># body = urllib.urlencode(application_parameter)</span>
            <span style="color:#268bd2">body</span> = <span style="color:#268bd2">urllib</span>.<span style="color:#268bd2">parse</span>.<span style="color:#268bd2">urlencode</span>(<span style="color:#268bd2">application_parameter</span>)    <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>

        <span style="color:#93a1a1;font-style:italic"># url = N_REST + &#34;?&#34; + urllib.urlencode(sys_parameters)</span>
        <span style="color:#268bd2">url</span> = <span style="color:#268bd2">N_REST</span> + <span style="color:#2aa198">&#34;?&#34;</span> + <span style="color:#268bd2">urllib</span>.<span style="color:#268bd2">parse</span>.<span style="color:#268bd2">urlencode</span>(<span style="color:#268bd2">sys_parameters</span>)   <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
        <span style="color:#268bd2">connection</span>.<span style="color:#268bd2">request</span>(<span style="color:#268bd2">self</span>.<span style="color:#268bd2">__httpmethod</span>, <span style="color:#268bd2">url</span>, <span style="color:#268bd2">body</span>=<span style="color:#268bd2">body</span>, <span style="color:#268bd2">headers</span>=<span style="color:#268bd2">header</span>)
        <span style="color:#268bd2">response</span> = <span style="color:#268bd2">connection</span>.<span style="color:#268bd2">getresponse</span>()
        <span style="color:#859900">if</span> <span style="color:#268bd2">response</span>.<span style="color:#268bd2">status</span> <span style="color:#859900">is</span> <span style="color:#859900">not</span> <span style="color:#2aa198;font-weight:bold">200</span>:
            <span style="color:#859900">raise</span> <span style="color:#268bd2">RequestException</span>(<span style="color:#2aa198">&#39;invalid http status &#39;</span> + <span style="color:#cb4b16">str</span>(
                <span style="color:#268bd2">response</span>.<span style="color:#268bd2">status</span>) + <span style="color:#2aa198">&#39;,detail body:&#39;</span> + <span style="color:#268bd2">response</span>.<span style="color:#268bd2">read</span>())
        <span style="color:#93a1a1;font-style:italic"># result = response.read()</span>
        <span style="color:#268bd2">result</span> = <span style="color:#268bd2">response</span>.<span style="color:#268bd2">read</span>().<span style="color:#268bd2">decode</span>(<span style="color:#2aa198">&#39;utf-8&#39;</span>)    <span style="color:#93a1a1;font-style:italic"># sudoz: Py3里JSON只接收unicode</span>
        <span style="color:#268bd2">jsonobj</span> = <span style="color:#268bd2">json</span>.<span style="color:#268bd2">loads</span>(<span style="color:#268bd2">result</span>)
        <span style="color:#859900">return</span> <span style="color:#268bd2">jsonobj</span>

    <span style="color:#859900">def</span> <span style="color:#268bd2">getApplicationParameters</span>(<span style="color:#268bd2">self</span>):
        <span style="color:#268bd2">application_parameter</span> = {}
        <span style="color:#93a1a1;font-style:italic"># for key, value in self.__dict__.iteritems():</span>
        <span style="color:#859900">for</span> <span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">__dict__</span>.<span style="color:#268bd2">items</span>():
            <span style="color:#859900">if</span> <span style="color:#859900">not</span> <span style="color:#268bd2">key</span>.<span style="color:#268bd2">startswith</span>(
                    <span style="color:#2aa198">&#34;__&#34;</span>) <span style="color:#859900">and</span> <span style="color:#859900">not</span> <span style="color:#268bd2">key</span> <span style="color:#859900">in</span> <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getMultipartParas</span>() <span style="color:#859900">and</span> <span style="color:#859900">not</span> <span style="color:#268bd2">key</span>.<span style="color:#268bd2">startswith</span>(
                    <span style="color:#2aa198">&#34;_RestApi__&#34;</span>) <span style="color:#859900">and</span> <span style="color:#268bd2">value</span> <span style="color:#859900">is</span> <span style="color:#859900">not</span> <span style="color:#268bd2">None</span>:
                <span style="color:#859900">if</span> (<span style="color:#268bd2">key</span>.<span style="color:#268bd2">startswith</span>(<span style="color:#2aa198">&#34;_&#34;</span>)):
                    <span style="color:#268bd2">application_parameter</span>[<span style="color:#268bd2">key</span>[<span style="color:#2aa198;font-weight:bold">1</span>:]] = <span style="color:#268bd2">value</span>
                <span style="color:#859900">else</span>:
                    <span style="color:#268bd2">application_parameter</span>[<span style="color:#268bd2">key</span>] = <span style="color:#268bd2">value</span>
        <span style="color:#93a1a1;font-style:italic"># 查询翻译字典来规避一些关键字属性</span>
        <span style="color:#268bd2">translate_parameter</span> = <span style="color:#268bd2">self</span>.<span style="color:#268bd2">getTranslateParas</span>()
        <span style="color:#93a1a1;font-style:italic"># for key, value in application_parameter.iteritems():</span>
        <span style="color:#859900">for</span> <span style="color:#268bd2">key</span>, <span style="color:#268bd2">value</span> <span style="color:#859900">in</span> <span style="color:#268bd2">application_parameter</span>.<span style="color:#268bd2">items</span>():  <span style="color:#93a1a1;font-style:italic"># sudoz: Py3</span>
            <span style="color:#859900">if</span> <span style="color:#268bd2">key</span> <span style="color:#859900">in</span> <span style="color:#268bd2">translate_parameter</span>:
                <span style="color:#268bd2">application_parameter</span>[<span style="color:#268bd2">translate_parameter</span>[<span style="color:#268bd2">key</span>]] = \
                <span style="color:#268bd2">application_parameter</span>[<span style="color:#268bd2">key</span>]
                <span style="color:#859900">del</span> <span style="color:#268bd2">application_parameter</span>[<span style="color:#268bd2">key</span>]
        <span style="color:#859900">return</span> <span style="color:#268bd2">application_parameter</span>
</code></pre></div></div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://isudox.com/tags/python">Python</a></li>
    </ul>
  </footer>

  

<div id="disqus_thread"></div>
<script>
    

    

    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;
        var d = document, s = d.createElement('script');
        
        var disqus_shortname = 'isudox';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article></main>
<footer class="footer">
  <span>&copy; 2015 - 2021</span>
  <span>&middot;</span>
  <span><a href="https://isudox.com/">I sudo X</a></span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Theme️ <a href="https://github.com/isudox/hugo-theme-nova/" rel="noopener" target="_blank">Nova</a></span>
</footer>
</body>

</html>

